<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Forecaster</title>
    <link rel="stylesheet" th:href="@{/styles/css/styles.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.9/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script th:src="@{/scripts/multiselect-dropdown.js}"></script>
    <script>
        // Toggles visibility of dropdown
        function toggleDropdown(event, dropdownId) {
            event.preventDefault(); // Prevent the default button behavior
            const dropdown = document.getElementById(dropdownId);


            if (dropdown.style.display === "none" || dropdown.style.display === "") {
                dropdown.style.display = "block";
            } else {
                dropdown.style.display = "none";
            }
        }

    </script>

</head>

<body>
<header >
    <h1>Football Forecaster</h1>
</header>

<main>


    <div class="container">
        <div class="search-section">
            <h2>Pick 2 teams</h2>
        </div>

        <div class="dropdown-container">
            <div class="dropdown">
                <form class="form1" id="form1">
                    <input class="search-bar" type="search" id="query" name="q" placeholder="Search...." readonly>
                    <button type="button" onclick="toggleDropdown(event, 'teamDropdown1')" class="dropbtn">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
                <!-- TEMPLATE LITERAL -->
                <div id="teamDropdown1" class="dropdown-content" style="display:none;">
                    <ul>
                        <li th:each="team : ${teams}">
                            <a href="#"
                               th:attr="onclick=|document.getElementById('query').value = '${team.displayName}';
                               document.getElementById('query').setAttribute('data-id', '${team.id}');
                               document.getElementById('query').setAttribute('short', '${team.abbreviation}');
                               const dropdown = document.getElementById('teamDropdown1');
                               dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';|"
                               th:text="${team.displayName}"></a>
                        </li>

                    </ul>
                </div>
            </div>

            <div class="dropdown">
                <form class="form2" id="form2">
                    <input class="search-bar" type="search" id="query2" name="q" placeholder="Search...." readonly>
                    <button type="button" onclick="toggleDropdown(event, 'teamDropdown2')" class="dropbtn">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
                <div id="teamDropdown2" class="dropdown-content" style="display:none;">
                    <ul>
                        <li th:each="team : ${teams}">
                            <a href="#"
                               th:attr="onclick=|document.getElementById('query2').value =  '${team.displayName}';
                                 document.getElementById('query2').setAttribute('data-id', '${team.id}');
                                 document.getElementById('query2').setAttribute('short', '${team.abbreviation}');
                                const dropdown = document.getElementById('teamDropdown2');
                                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';|"
                               th:text="${team.displayName}"></a>
                        </li>

                    </ul>
                </div>
            </div>
        </div>
        <button class = "findbttn"
        onclick="findGameDates()">
            Find Game Dates
        </button>
        <div class="calendar-section">
            <h2>Select Game Date</h2>
            <input type="text" id="game-date" class="calendar-input" placeholder="Pick a date" >
        </div>
        <div id="game-list" style="display: none;"></div>

    </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.9/flatpickr.min.js"></script>
<script>
    let gameData = {}; // Object to store games grouped by date

    function fetchAndPopulateCalendar() {
        fetch('/events/schedule')
            .then(response => response.json())
            .then(games => {
                console.log("Fetched Games:", games);

                if (Array.isArray(games)) {

                    gameData = {};


                    games.forEach(game => {
                        const gameDate = new Date(game.date);

                        gameDate.setHours(gameDate.getHours() - 5);


                        const formattedDate = gameDate.toISOString().split('T')[0];


                        const homeTeamId = game.homeTeam.id;
                        const awayTeamId = game.awayTeam.id;

                        if (!gameData[formattedDate]) {
                            gameData[formattedDate] = [];
                        }
                        gameData[formattedDate].push({
                            homeTeam: { id: homeTeamId, displayName: game.homeTeam.displayName },
                            awayTeam: { id: awayTeamId, displayName: game.awayTeam.displayName },
                            gameDate: gameDate,
                            gameId: game.id
                        });
                    });

                    console.log("Game Data by Date:", gameData);

                    flatpickr("#game-date", {
                        enableTime: false,
                        dateFormat: "Y-m-d",
                        onDayCreate: function(dObj, dStr, fp, dayElem) {
                            const date = dayElem.dateObj;
                            const dateString = date.toISOString().split('T')[0];

                            // Highlight days that have games
                            if (gameData[dateString]) {
                                dayElem.classList.add("has-games");
                                dayElem.addEventListener('click', () => {
                                    showGameDetails(dateString);
                                });
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error("Error fetching future games:", error);
            });
    }


    // Show game details for the selected date
    function showGameDetails(date) {
        const gameListElement = document.getElementById('game-list');
        gameListElement.innerHTML = '';

        const gamesForDate = gameData[date];

        if (gamesForDate && gamesForDate.length > 0) {
            gameListElement.style.display = 'block';

            gamesForDate.forEach(game => {
                const gameElement = document.createElement('div');
                gameElement.classList.add('game-item');
                gameElement.textContent = `${game.awayTeam.displayName} vs ${game.homeTeam.displayName}`;


                gameElement.addEventListener('click', () => {
                    const homeTeamId = game.homeTeam.id;
                    const awayTeamId = game.awayTeam.id;
                    window.location.href = `/prediction?home=${homeTeamId}&away=${awayTeamId}`;
                });

                gameListElement.appendChild(gameElement);
            });
        } else {
            gameListElement.style.display = 'none';
        }
    }


    document.addEventListener('DOMContentLoaded', fetchAndPopulateCalendar);




    function findGameDates() {
        // Get the values from the search bars
        const teamName1 = document.getElementById('query').value;
        const teamName2 = document.getElementById('query2').value;
        const teamId1 = document.getElementById('query').getAttribute('data-id');
        const teamId2 = document.getElementById('query2').getAttribute('data-id');
        const team1Ab = document.getElementById('query').getAttribute('short');
        const team2Ab = document.getElementById('query2').getAttribute('short');
        let shortName = "";

        if (teamName1 && teamName2) {
            shortName = team1Ab + " @ " + team2Ab;
        }

        console.log("Team 1 Name: " + teamName1 + " team1 id: " + teamId1 + " abv: " + team1Ab);
        console.log("Team 2 Name: " + teamName2 + " team2 id: " + teamId2 + " abv: " + team2Ab);
        console.log(shortName);

        // First fetch attempt with initial homeTeamId and awayTeamId
        fetch(`/events?homeId=${teamId1}&awayId=${teamId2}`)
            .then(async response => {
               return {
                    status: response.status,
                    data: await response.json()
                }
            })
            .then(response => {
                console.log(response);
                if (response.status === 200) {
                    //TODO: the /events endpoint now returns a list of events matching both team ids
                    //TODO: maybe change this to select multiple dates if multiple events are returned
                    console.log("date:", response.data[0].date);
                    const gameDate = response.data[0].date;
                    const calendarInput = document.getElementById('game-date');
                    calendarInput.value = gameDate;
                    const homeTeamId = teamId1;
                    const awayTeamId = teamId2;

                    // Reinitialize Flatpickr to make sure it's set to the selected date
                    flatpickr("#game-date", {
                        defaultDate: gameDate,
                        enableTime: false,
                        dateFormat: "Y-m-d",
                        onChange: function(selectedDates, dateStr, instance) {
                            // Navigate to prediction.html with the selected date as a query parameter
                            window.location.href = `/prediction?home=${homeTeamId}&away=${awayTeamId}`;
                        }
                    });
                }
            })
            .catch(error => {
                console.error("Error finding game date:", error);
                alert("There was an error finding the game date.");
            });
    }
    flatpickr("#game-date", {
        enableTime: false,
        dateFormat: "Y-m-d",
    });




    // Close dropdowns if clicked outside
    document.addEventListener("click", function (e) {
        const dropdowns = document.querySelectorAll(".dropdown-content");
        dropdowns.forEach(dropdown => {
            const isClickInsideDropdown = dropdown.contains(e.target);
            const isClickOnButton = e.target.closest(".dropbtn");

            if (!isClickInsideDropdown && !isClickOnButton) {
                dropdown.style.display = "none"; // Hide the dropdown if clicked outside
            }
        });
    });





</script>
</body>

</html>
